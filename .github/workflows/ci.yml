name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm install --prefer-offline
          else
            echo "No package.json found — skipping install."
          fi

      - name: Run ESLint
        run: |
          if [ -d "apps/web/src" ]; then
            cd apps/web && npx next lint --no-cache
          else
            echo "No apps/web source on this branch — skipping lint."
          fi

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm install --prefer-offline
          else
            echo "No package.json found — skipping install."
          fi

      - name: Run TypeScript compiler
        run: |
          if [ -f "apps/web/tsconfig.json" ] && [ -d "apps/web/src" ]; then
            cd apps/web && npx tsc --noEmit
          else
            echo "No apps/web source found on this branch — skipping typecheck."
          fi

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm install --prefer-offline
          else
            echo "No package.json found — skipping install."
          fi

      - name: Run tests
        run: |
          if [ -d "apps/web/src" ]; then
            cd apps/web && npx vitest run --reporter=verbose 2>/dev/null || echo "No tests defined yet — skipping."
          elif [ -d "tests" ] && [ -f "vitest.config.ts" ]; then
            npx vitest run --reporter=verbose 2>/dev/null || echo "No tests defined yet — skipping."
          else
            echo "No testable source on this branch — skipping tests."
          fi

  go-ci:
    name: Go Agent (build + vet)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: agent/go.mod
          cache-dependency-path: agent/go.sum

      - name: go vet
        run: cd agent && go vet ./...

      - name: Build all platforms
        run: |
          cd agent
          GOOS=linux   GOARCH=amd64 go build -o /dev/null ./cmd/sessionforge
          GOOS=linux   GOARCH=arm64 go build -o /dev/null ./cmd/sessionforge
          GOOS=darwin  GOARCH=amd64 go build -o /dev/null ./cmd/sessionforge
          GOOS=darwin  GOARCH=arm64 go build -o /dev/null ./cmd/sessionforge
          GOOS=windows GOARCH=amd64 go build -o /dev/null ./cmd/sessionforge
        env:
          CGO_ENABLED: "0"

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm install --prefer-offline
          else
            echo "No package.json found — skipping install."
          fi

      - name: Build Next.js app
        run: |
          if [ -d "apps/web/src" ]; then
            cd apps/web && npx next build
          else
            echo "No Next.js app source on this branch — skipping build."
          fi
        env:
          DATABASE_URL: postgresql://sessionforge:localdev@localhost:5432/sessionforge
          NEXTAUTH_SECRET: ci-placeholder-secret-not-real
          NEXTAUTH_URL: http://localhost:3000
          NEXT_TELEMETRY_DISABLED: "1"
