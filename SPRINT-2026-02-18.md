# SessionForge Sprint — 2026-02-18
# Auth Fix + Pre-Launch Polish

## Sprint Goal
Fix completely broken signup/auth, get users through the door, ship legal pages, distribute agent binaries.

---

## Parallel Agent Assignments

| Agent | Worktree | Branch | Priority Tasks |
|-------|----------|--------|----------------|
| **Backend** | `.worktrees/agent-backend` | `dev/backend` | TASK-1: Fix auth (adapter+JWT), TASK-7: Rate limiting + Sentry |
| **Frontend** | `.worktrees/agent-frontend` | `dev/frontend` | TASK-2: Fix signup flow, TASK-3: Legal pages |
| **Desktop** | `.worktrees/agent-desktop` | `dev/desktop` | TASK-5: Publish Go agent binaries |
| **Infra** | `.worktrees/agent-infra` | `dev/infra` | TASK-4: Redeploy Cloud Run (after backend fix) |
| **QA** | `.worktrees/agent-qa` | `dev/qa` | TASK-6: E2E test auth after deploy |

---

## TASK-1 — Fix Auth [CRITICAL BLOCKER] (Backend)

**File:** `apps/web/src/lib/auth.ts`

### Root Causes (3 bugs)

**Bug 1:** `DrizzleAdapter` + `strategy: 'jwt'` conflict
- Line 23: `adapter: process.env.DATABASE_URL ? DrizzleAdapter(getRealDb()) : undefined`
- NextAuth v5 with JWT strategy does NOT use the adapter for session storage
- But the adapter still intercepts OAuth provider callbacks and tries to create/link accounts in its own schema — conflicting with the manual user creation in `signIn` callback

**Fix:** Remove the DrizzleAdapter entirely. Keep all DB interaction in callbacks.

**Bug 2:** Resend env var mismatch
- Code reads: `process.env.AUTH_RESEND_KEY` (line 102)
- Cloud Run has: `RESEND_API_KEY`
- Magic link silently fails with no error

**Fix:** Change to `process.env.AUTH_RESEND_KEY ?? process.env.RESEND_API_KEY`

**Bug 3:** OAuth signIn callback double-inserts
- The manual `db.insert(users)` in signIn callback may conflict with adapter's own insert
- Removing adapter (Bug 1 fix) resolves this automatically

### Implementation

```typescript
// auth.ts — remove adapter line, fix Resend key
export const authConfig: NextAuthConfig = {
  // REMOVE: adapter: process.env.DATABASE_URL ? DrizzleAdapter(getRealDb()) : undefined,
  secret: process.env.NEXTAUTH_SECRET ?? process.env.AUTH_SECRET,
  trustHost: true,
  session: { strategy: 'jwt', maxAge: 30 * 24 * 60 * 60 },
  // ...rest stays the same...

  // Fix Resend provider:
  Resend({
    apiKey: process.env.AUTH_RESEND_KEY ?? process.env.RESEND_API_KEY,
    from: process.env.EMAIL_FROM ?? 'noreply@sessionforge.dev',
  }),
}
```

---

## TASK-2 — Fix Signup Flow (Frontend)

- Audit `/app/(auth)/signup/page.tsx` — ensure it calls `/api/auth/register`
- Audit `/api/auth/register/route.ts` — ensure it: hashes password with bcrypt, inserts user into `users` table, returns 201
- After success, redirect to `/verify-email` (or `/login` with success message)
- Verify form validation matches backend schema (email + min 8 char password)

---

## TASK-3 — Legal Pages (Frontend)

Create real content (not lorem ipsum) for:
- `/app/(marketing)/terms/page.tsx` — Terms of Service
- `/app/(marketing)/privacy/page.tsx` — Privacy Policy
- `/app/(marketing)/aup/page.tsx` — Acceptable Use Policy

Use the existing marketing layout. Keep consistent with current Tailwind dark theme.

---

## TASK-4 — Redeploy Cloud Run (Infra) [BLOCKED on TASK-1]

1. Merge `dev/backend` fixes to `dev/integration`
2. Verify Cloud Run env vars:
   - Rename `RESEND_API_KEY` → `AUTH_RESEND_KEY` OR keep both (code now reads both)
   - Confirm `NEXTAUTH_URL=https://sessionforge.dev`
   - Confirm `NEXTAUTH_SECRET` is set
3. Deploy:
```bash
gcloud run deploy sessionforge \
  --source . \
  --region us-central1 \
  --project sessionforge-487719 \
  --allow-unauthenticated
```
4. Test: anythingjoes@hotmail.com magic link + Google + GitHub

---

## TASK-5 — Agent Binary Distribution (Desktop)

1. Create `.github/workflows/release-agent.yml` using goreleaser
2. Build targets: linux/amd64, linux/arm64, darwin/amd64, darwin/arm64, windows/amd64
3. Tag: `git tag v0.1.0 && git push origin v0.1.0`
4. Create `apps/web/public/install.sh` and `apps/web/public/install.ps1`
5. Verify download links work from sessionforge.dev/install.sh

---

## TASK-6 — E2E Auth Tests (QA) [BLOCKED on TASK-4]

Run Playwright tests after deployment:
- [ ] Magic link: signup → check email → click link → land on dashboard
- [ ] Google OAuth: click → authorize → dashboard
- [ ] GitHub OAuth: click → authorize → dashboard
- [ ] Credentials: signup → login with email/password → dashboard
- [ ] Onboarding wizard: 5 steps complete
- [ ] Dashboard loads with user data

---

## TASK-7 — Rate Limiting + Sentry (Backend)

1. Install: `@upstash/ratelimit` (already have Redis)
2. Add middleware in `apps/web/src/middleware.ts` or individual API routes
3. Limits: 5 login attempts/15min per IP, 3 magic link requests/hour per email
4. Add `@sentry/nextjs` — configure `sentry.client.config.ts` and `sentry.server.config.ts`
5. Add `SENTRY_DSN` to Cloud Run env vars

---

## Integration Protocol

1. Each agent commits to their branch frequently
2. Backend (TASK-1) must complete first — unblocks Infra (TASK-4) and QA (TASK-6)
3. Frontend (TASK-2, TASK-3) and Desktop (TASK-5) run in parallel immediately
4. Infra deploys once backend branch is ready
5. QA runs after deploy

## Done Criteria

- [ ] User can sign up with email magic link at sessionforge.dev
- [ ] User can sign up with Google at sessionforge.dev
- [ ] User can sign up with GitHub at sessionforge.dev
- [ ] User lands on dashboard after auth
- [ ] Legal pages exist at /terms, /privacy, /aup
- [ ] Agent install script works at sessionforge.dev/install.sh
